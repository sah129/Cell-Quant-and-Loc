
```{r}
source('src/functions.R')
datasetpath <- "Datasets/samp"
```
Figure 1B: sigma = .3, offset= 0.002, cutoff = 50

"C:\Users\Sarah's Computer\Desktop\Git1 Quant\Sarah\Results No Settings-NewVac\Figure 2C\Images\aly2-del_415Git1_003_final_results.tiff"

```{r, echo = FALSE}
imageset <- read_in_imageset_files(datasetpath)
channels <- read_in_channels(imageset[1,], datasetpath) #006
img_gray <- convert_to_grayscale(channels)
membranes <- detect_membranes_new(img_gray, channels,16, img_gray[,,gfp_channel],1000)
vacuoles <- find_vacuoles(membranes, img_gray, channels)
```

```{r}
res <- exclude_and_bind(membranes, vacuoles)
final<-tidy_up(membranes,vacuoles,res)
```


```{r}
b <- max(membranes$FM[,"membrane.0.s.radius.min"]) 
vmask = thresh(img_gray[,,cmac_channel],w=b,h=b,offset = 2*sd(img_gray[,,cmac_channel]))

cn <- normalize(img_gray[,,cmac_channel])
vacs <- cn > otsu(cn)

t <- paintObjects(vmask, tgt = channel(cn, 'asblue'), col = 'yellow')
tt <- paintObjects(vacs, tgt = channel(cn, 'asblue'), col = 'yellow')

display(t)
display(tt)
```








```{r}
d<-get_displ(channels,final)
display(d)
```


```{r}
  
chan <- normalize(img_gray[,,dic_channel])
factor = 2
cutoff  = 100

g <- gblur(chan*factor, sigma = 2)

ct = thresh(g)
cm = bwlabel(ct)
fm <- computeFeatures.shape(cm)
noise <- which(fm[,"s.area"]< cutoff) # noise removal

mems <- rmObjects(cm, noise)
#res <- remove_edge_membranes(membranes, img, channels)
display(mems)
```








```{r}
get_displ <- function(channels, final)
{
  t<-paintObjects(final$membranes, tgt = channel(normalize(channels$gfp), 'asgreen'), col = c('white','white'))
  tt<-paintObjects(final$vacuoles, tgt = t, col = 'yellow')
  return(tt)
}
```







```{r}
 # c<-clahe(ngfp, nx = 4, ny = 4, limit=2, keep.range = TRUE)
  g <- gblur(img_gray[,,gfp_channel]*16, sigma = 2)
  ct = thresh(g)
  cm = bwlabel(ct)
  fm <- computeFeatures.shape(cm)
  noise <- which(fm[,"s.area"]< 100) # noise removal
  
  m <- rmObjects(cm, noise)
  display(m)
  
  res<-remove_edge_membranes(m, img_gray, channels)
  display(res$membranes)
```

```{r}
display(img_gray[,,gfp_channel])
```

```{r}
res$df
```



```{r}
display(res$membranes)
```

```{r}
detect_membranes_alternate <- function(channels)
{
    cmac <- normalize(channels$cmac*16)
    gfp <- normalize(channels$gfp)
    
    vacs <- cmac > otsu(cmac)
    gfp <- gfp*(1-vacs)
    mems <- thresh(gfp)
    return(mems)
}

```

```{r}
mems <- detect_membranes_alternate(channels)
```


```{r}
p<-paintObjects(mems, tgt = channels$gfp, col = c('white','white'))
display(p)
```




```{r}
v<-paintObjects(vacuoles$vacuoles, tgt = normalize(channel(channels$cmac, 'asblue')), col = 'yellow')
display(v)
```




```{r}
get_display_img(df = final$df,
                membranes = final$membranes, 
                col_membranes = 'white', 
                vacuoles = final$vacuoles, 
                col_vacuoles ='yellow', 
                removed = membranes$removed,
                closed_vacuoles = FALSE, 
                img = toRGB(channels$gfp), 
                showRemoved = FALSE, 
                showMemLabels = TRUE, 
                showVacLabels = FALSE)
```


```{r}
m1 <- final$membranes == 31
m2<- final$membranes == 24
v1<-final$vacuoles==38
v2<-final$vacuoles==30
```







```{r}
cells_blurred = gblur(img_gray[,,gfp_channel], sigma = .5)
ct = thresh(cells_blurred, offset = 0.002)

cm = bwlabel(ct)
FS = computeFeatures.shape(cm)
sel <- which(FS[,"s.area"] < 600)
membranes <-rmObjects(cm, sel)
display(membranes)
```















